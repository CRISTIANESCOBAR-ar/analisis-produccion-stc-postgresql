import{w as we,o as je,a as m,c as y,b as n,t as x,d as I,f as D,j as X,e as _,F as ee,r as ge,s as He,m as v,p as te,n as be,i as T,g as De,h as R,u as Me,x as $e,T as Ge,l as M}from"./index-DYTbJAB1.js";import{S as N}from"./sweetalert2.esm.all-AlKuj1Cq.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Je={class:"hidden md:flex w-full h-screen flex-col p-1 tenso-component"},We={class:"w-full flex-1 min-h-0 bg-white rounded-2xl shadow-xl px-4 py-3 border border-slate-200 flex flex-col overflow-y-auto"},Ke={class:"flex-shrink-0 mb-3 flex items-center gap-3"},Ye={class:"w-64 min-w-0"},ze=["title"],qe={class:"flex items-center gap-2"},Ze={class:"flex-1 flex flex-col mt-2 bg-white rounded-2xl shadow-sm p-4 border border-slate-200 min-h-0"},Qe={class:"flex-shrink-0 mt-2 flex items-center justify-between gap-4"},Xe={class:"flex items-center gap-4"},et={class:"inline-flex items-center text-sm cursor-pointer"},tt={class:"inline-flex items-center text-sm cursor-pointer"},st={class:"inline-flex items-center text-sm cursor-pointer"},nt={key:0,class:"ml-4"},ot={class:"font-semibold text-lg text-slate-800 mb-0"},rt={key:0,class:"ml-2 text-slate-600"},at={class:"flex-1 min-h-0 mt-4 flex flex-col xl:flex-row gap-4 tenso-grid"},lt={class:"flex flex-col h-full min-h-0 xl:w-[60%] flex-shrink-0"},it={class:"flex-1 min-h-0 overflow-y-auto _minimal-scroll"},ct={class:"text-xs border-collapse fixed-table scan-table w-full"},dt=["onClick"],ut={class:"px-2 py-[0.3rem] border border-slate-200 text-xs text-center text-slate-700"},ft={class:"px-2 py-[0.3rem] border border-slate-200 text-center text-xs"},pt=["checked"],ht={class:"px-2 py-[0.3rem] border border-slate-200 text-center text-xs"},vt=["checked"],xt={class:"px-2 py-[0.3rem] border border-slate-200 text-center text-xs"},wt={key:0,title:"Guardado en la base de datos"},gt={class:"px-2 py-[0.3rem] border border-slate-200 text-center text-xs font-mono text-slate-700"},bt={class:"px-2 py-[0.3rem] border border-slate-200 text-center text-xs font-mono text-slate-700"},mt=["onUpdate:modelValue","placeholder","readonly","onFocus","onInput","onKeydown"],yt={key:0,class:"flex items-center gap-1 justify-center"},Tt=["onClick","onKeydown"],Et=["onClick","disabled","onKeydown"],St={key:1,class:"flex gap-1 justify-center"},kt=["onClick","disabled","onKeydown"],Ct=["onClick","disabled"],_t=["onClick","disabled","onKeydown"],Nt={class:"flex-shrink-0 flex items-center gap-2 mt-3"},Ot={class:"text-sm font-medium text-slate-600"},Rt={key:0,class:"text-sm text-slate-500 flex items-center gap-2"},At={class:"flex flex-col min-w-0 xl:w-[40%] flex-shrink"},Ut={class:"overflow-x-auto overflow-y-auto _minimal-scroll max-h-96 min-w-0"},Bt={class:"min-w-full text-sm border-collapse tbl-centered"},Lt={class:"p-1.5 border border-slate-200 text-xs text-center text-slate-700"},It={class:"p-1.5 border border-slate-200 text-xs font-mono text-slate-700"},Pt={class:"p-1.5 border border-slate-200 text-xs font-mono text-slate-700"},Ft={class:"p-1.5 border border-slate-200 text-xs font-mono bg-blue-50 text-center font-semibold text-slate-700"},jt={class:"p-1.5 border border-slate-200 text-xs font-mono text-right text-slate-700 tbl-td-tiempo"},Ht={class:"p-1.5 border border-slate-200 text-xs font-mono text-right text-slate-700"},Dt={class:"p-1.5 border border-slate-200 text-xs font-mono text-right text-slate-700"},Mt={class:"p-1.5 border border-slate-200 text-xs font-mono text-right text-slate-700"},$t={class:"p-1.5 border border-slate-200 text-xs font-mono text-right text-slate-700"},se=10,Gt={__name:"TensoRapid",setup(Vt){const $=v(null),P=v(""),J=v(!1),p=v([]),S=v(""),k=v(""),W=v(!1),A=v(!1),U=v(!1),w=v("not"),F=v({}),ne=v({}),oe=v({}),re=v({}),me=te(()=>{const e=Array.isArray(p.value)?p.value.slice():[];let t=[];if(e.length===0)t=[];else if(w.value==="all")t=e;else{const l=w.value==="saved",o=w.value==="not";!l&&!o?t=e:t=e.filter(a=>{const c=!!a.saved;return c&&l||!c&&o})}const s=[];if(t.length===0){for(let l=0;l<se;l++)s.push({testnr:"",hasPar:!1,hasTbl:!1,nomcount:"",maschnr:""});return s}if(t.length>=se)return t;for(s.push(...t);s.length<se;)s.push({testnr:"",hasPar:!1,hasTbl:!1,nomcount:"",maschnr:""});return s});function j(e,t,s){if(!e||e===0)return"No se encontraron archivos .PAR/.TBL válidos en la carpeta seleccionada";if(s==="all")return`Encontrados ${e} ensayos (mostrando todos)`;if(t==null){if(s==="saved")return`Encontrados ${e} ensayos (mostrando guardados)`;if(s==="not")return`Encontrados ${e} ensayos (mostrando no guardados)`}const l=e-(t||0);return s==="saved"?`Encontrados ${e} ensayos (${t} guardados)`:s==="not"?`Encontrados ${e} ensayos (${l} no guardados)`:`Encontrados ${e} ensayos`}function ae(){const e=Array.isArray(p.value)?p.value.length:0,s=Array.isArray(p.value)&&p.value.some(l=>typeof l.saved<"u")?p.value.reduce((l,o)=>l+(o.saved?1:0),0):null;k.value=j(e,s,w.value)}we(w,()=>ae()),we(p,()=>ae(),{deep:!0});async function ye(e){try{const t=typeof window<"u"&&window.location.hostname==="localhost"?"http://localhost:3001":"",l=await fetch("/api/uster/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({testnrs:[e]}),credentials:"include"});if(!l.ok)return!1;const o=await l.json();return o&&Array.isArray(o.existing)&&o.existing.includes(e)}catch{return!1}}async function Te(e,t){try{const s=typeof window<"u"&&window.location.hostname==="localhost"?"http://localhost:3001":"",o=await fetch("/api/uster/husos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({testnr:e}),credentials:"include"});if(!o.ok){const u=await o.json().catch(()=>null);return{valid:!1,error:`No se pudo verificar la coincidencia de Husos: ${u&&u.error?u.error:`HTTP ${o.status}`}`}}const a=await o.json();if(!a||!Array.isArray(a.husos))return{valid:!1,error:"No se encontraron datos de Husos para el ensayo Uster"};if(a.husos.length===0)return{valid:!1,error:`El ensayo Uster ${e} no tiene husos registrados en USTER_TBL`};const c=t.map(u=>{const f=u[1]&&u[1].trim()!==""?u[1].trim():null;if(f){const h=f.match(/^(\d+)\//);if(h&&h[1])return parseInt(h[1],10)}return null}).filter(u=>u!==null);if(c.length===0)return{valid:!1,error:"No se pudieron extraer números de Huso del archivo TensoRapid"};const r=a.husos.map(u=>parseInt(u,10)),i=c.filter(u=>!r.includes(u)),d=r.filter(u=>!c.includes(u));return i.length>0||d.length>0?{valid:!1,hasDiscrepancies:!0,usterHusos:r,tensoHusos:c,husosInTensoNotInUster:i,husosInUsterNotInTenso:d,canAutoFix:!0}:{valid:!0}}catch(s){return{valid:!1,error:"Error al validar coincidencia de Husos: "+(s.message||String(s))}}}async function Ee(e){if(e){S.value=e;try{await G(e)}catch{}}}async function Se(e){if(!(!e||!e.testnr||!e.usterTestnr)&&!A.value){A.value=!0;try{if(await G(e.testnr),!E.value||Object.keys(E.value).length===0)throw new Error("No se pudieron cargar los datos del archivo .PAR");if(!b.value||b.value.length===0)throw new Error("No se pudieron cargar los datos del archivo .TBL");if(!await ye(e.usterTestnr))throw new Error(`El ensayo Uster ${e.usterTestnr} no existe en la base de datos. Debe cargarse primero en la página Uster.`);const s=await Te(e.usterTestnr,b.value);if(!s.valid)if(s.hasDiscrepancies&&s.canAutoFix){N.close();let d='<div style="text-align: left; font-size: 14px;">';d+="<p><strong>Se detectaron diferencias en los números de Huso:</strong></p>",s.husosInTensoNotInUster.length>0&&(d+=`<p>• Husos en TensoRapid que <strong>NO están</strong> en Uster: <code>${s.husosInTensoNotInUster.join(", ")}</code></p>`),s.husosInUsterNotInTenso.length>0&&(d+=`<p>• Husos en Uster que <strong>NO están</strong> en TensoRapid: <code>${s.husosInUsterNotInTenso.join(", ")}</code></p>`),d+="<br><p><strong>¿Qué deseas hacer?</strong></p></div>";const u=await N.fire({icon:"warning",title:"Discrepancia en Husos",html:d,showDenyButton:!0,showCancelButton:!0,confirmButtonText:"✓ Usar Husos de Uster",confirmButtonColor:"#10b981",denyButtonText:"Guardar de todas formas",denyButtonColor:"#f59e0b",cancelButtonText:"Cancelar",cancelButtonColor:"#6b7280",width:"600px"});if(u.isDismissed){A.value=!1,await M();const f=F.value[e.testnr];f&&typeof f.select=="function"&&(f.focus(),f.select());return}if(u.isConfirmed)for(let f=0;f<b.value.length&&f<s.usterHusos.length;f++){const h=s.usterHusos[f];if(b.value[f][1]){const g=b.value[f][1].match(/^(\d+)\/(.+)$/);g&&(b.value[f][1]=`${h}/${g[2]}`)}}else u.isDenied}else throw new Error(s.error);const l={...E.value,USTER_TESTNR:e.usterTestnr},o=b.value.map((d,u)=>{const f=d[1]&&d[1].trim()!==""?d[1].trim():null;let h=null;if(f){const g=f.match(/^(\d+)\//);g&&g[1]&&(h=parseInt(g[1],10))}return(!h||isNaN(h))&&(h=u+1),{TESTNR:d[0]||l.TESTNR,HUSO_ENSAYOS:f,HUSO_NUMBER:h,TIEMPO_ROTURA:d[2]&&d[2].trim()!==""?d[2]:null,FUERZA_B:d[3]&&d[3].trim()!==""?d[3]:null,ELONGACION:d[4]&&d[4].trim()!==""?d[4]:null,TENACIDAD:d[5]&&d[5].trim()!==""?d[5]:null,TRABAJO:d[6]&&d[6].trim()!==""?d[6]:null}});N.fire({toast:!0,position:"top-end",icon:"info",title:"Guardando...",showConfirmButton:!1,timer:3e4,timerProgressBar:!0});const a=typeof window<"u"&&window.location.hostname==="localhost"?"http://localhost:3001":"",r=await fetch("/api/tensorapid/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({par:l,tbl:o}),credentials:"include"});let i=null;try{i=await r.json()}catch{i=null}if(!r.ok)throw new Error(i&&i.error?i.error:i&&i.message||`HTTP ${r.status}`);e.saved=!0,e.isEditing=!1;try{await Ue(e.testnr)}catch{}N.fire({toast:!0,position:"top-end",icon:"success",title:`Ensayo ${e.testnr} guardado`,text:`Vinculado con USTER ${e.usterTestnr}`,showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}catch(t){N.close(),await N.fire({icon:"error",title:"Error al guardar",html:`<div style="text-align: left;">${String(t&&t.message?t.message:t)}</div>`,confirmButtonText:"Entendido",confirmButtonColor:"#3b82f6",width:"500px"}),await M();const s=F.value[e.testnr];if(s&&typeof s.focus=="function"){s.focus();try{typeof s.select=="function"&&s.select()}catch{}}}finally{A.value=!1}}}async function le(e){if(!(!e||!e.testnr||!e.saved||!(await N.fire({title:`Eliminar ensayo ${e.testnr}?`,text:"Esto eliminará los registros en TENSORAPID_PAR y TENSORAPID_TBL. Esta acción no afecta USTER.",icon:"warning",showCancelButton:!0,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"})).isConfirmed)&&!U.value){U.value=!0;try{const s=typeof window<"u"&&window.location.hostname==="localhost"?"http://localhost:3001":"",o=await fetch("/api/tensorapid/delete",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({testnr:e.testnr}),credentials:"include"}),a=await o.json().catch(()=>null);if(!o.ok)throw new Error(a&&a.error?a.error:`HTTP ${o.status}`);p.value=(p.value||[]).filter(c=>c.testnr!==e.testnr),S.value===e.testnr&&(b.value=[],E.value={},S.value=""),N.fire({toast:!0,position:"top-end",icon:"success",title:`Ensayo ${e.testnr} eliminado`,showConfirmButton:!1,timer:3e3})}catch(s){console.error("deleteTensorapid error",s),await N.fire({icon:"error",title:"Error al eliminar",text:String(s&&s.message?s.message:s),confirmButtonText:"Cerrar"})}finally{U.value=!1}}}function ke(e){e&&(e.originalUsterTestnr=e.usterTestnr,e.isEditing=!0)}function Ce(e){e&&(e.originalUsterTestnr!==void 0&&(e.usterTestnr=e.originalUsterTestnr),e.isEditing=!1,e.originalUsterTestnr=void 0)}function _e(e,t){e&&(F.value[t]=e)}function Ne(e,t){e&&(ne.value[t]=e)}function Oe(e,t){e&&(oe.value[t]=e)}function ie(e,t){e&&(re.value[t]=e)}function ce(e){if(!e||!e.testnr)return;const t=F.value[e.testnr];t&&typeof t.focus=="function"&&t.focus()}function de(e){if(!e||!e.testnr||e.isEditing)return;const t=re.value[e.testnr];t&&typeof t.focus=="function"&&t.focus()}async function Re(e){if(!(!e||!e.testnr)&&S.value!==e.testnr)try{await G(e.testnr),S.value=e.testnr}catch(t){console.warn("Error loading TBL data on input focus",t)}}async function Ae(e,t){if(!e)return;let s=(t.target.value||"").replace(/\D/g,"");s.length>5&&(s=s.slice(0,5)),e.usterTestnr=s,s.length===5&&(e.usterTestnr=s.padStart(5,"0"),setTimeout(()=>K(e),100))}function K(e){if(!e||!e.testnr)return;const t=ne.value[e.testnr];t&&typeof t.focus=="function"&&t.focus()}function ue(e){if(!e||!e.testnr)return;const t=oe.value[e.testnr];t&&typeof t.focus=="function"&&t.focus()}function fe(e){e&&(e.saved&&!e.isEditing?ue(e):K(e))}async function Ue(e){try{await M();const t=Array.isArray(p.value)?p.value:[];if(t.length===0)return!1;const s=t.filter(r=>r&&r.testnr).filter(r=>w.value==="not"?!r.saved:w.value==="saved"?!!r.saved:!0).filter(r=>!r.usterTestnr||String(r.usterTestnr).trim()==="").map(r=>String(r.testnr));if(s.length===0)return b.value=[],S.value="",await M(),!1;const l=t.findIndex(r=>String(r.testnr)===String(e)),o=s.indexOf(String(e));let a=null;if(o>=0)a=s[(o+1)%s.length];else{let r=null;for(const i of s)if(t.findIndex(u=>String(u.testnr)===String(i))>l){r=i;break}r||(r=s[0]),a=r}if(!a)return!1;await M();try{await G(a),S.value=a}catch(r){console.warn("Failed to load files for next test",a,r)}const c=F.value[a];if(c&&typeof c.focus=="function"){c.focus();try{c.scrollIntoView({block:"center",behavior:"smooth"})}catch{}try{c.classList.add("focus-highlight"),setTimeout(()=>{try{c.classList.remove("focus-highlight")}catch{}},600)}catch{}return!0}}catch(t){console.warn("focusNextEmptyUster error",t)}return!1}function Y(e){if(!e)return"";const t=String(e).replace(/\D/g,"").slice(0,5);return t?t.padStart(5,"0"):""}async function G(e){try{B.value="",O.value="",E.value={},C.value="",L.value=e;const t=Array.isArray(p.value)?p.value.find(o=>o.testnr===e):null;if(t){try{if(t.parHandle&&typeof t.parHandle.getFile=="function"){const o=await t.parHandle.getFile();B.value=await o.text(),E.value=ve(B.value)}}catch(o){console.warn("reading .PAR from scan-list handles failed",o)}try{if(t.tblHandle&&typeof t.tblHandle.getFile=="function"){const o=await t.tblHandle.getFile();O.value=await o.text(),C.value=o.name||"",pe(O.value)}}catch(o){console.warn("reading .TBL from scan-list handles failed",o)}if(B.value||O.value)return}const s=await z("dir-tenso");if(!s){k.value="No hay acceso directo a la carpeta (fallback). Usa Seleccionar para elegir carpeta.";return}if(!await q(s,"read")){k.value="Permiso denegado para leer la carpeta. Vuelve a seleccionar la carpeta.";return}for await(const[o,a]of s.entries())try{if(!a||a.kind!=="file")continue;const c=String(o||"").toLowerCase();if(!String(o).includes(e))continue;if(c.endsWith(".par"))try{const r=await a.getFile();B.value=await r.text(),E.value=ve(B.value)}catch(r){console.warn("reading .PAR selected",r)}if(c.endsWith(".tbl"))try{const r=await a.getFile();O.value=await r.text(),C.value=r.name||"",pe(O.value)}catch(r){console.warn("reading .TBL selected",r)}}catch(c){console.warn("error iterating directory entries",c)}}catch(t){console.warn("loadSelectedTensoFiles error",t),k.value="Error al cargar archivos seleccionados: "+(t&&t.message?t.message:String(t))}}function pe(e){if(O.value=e||"",!e)return;const t=e.split(/\r?\n/),s=5;let l="";if(C.value&&C.value.length>=12)l=C.value.slice(6,12);else if(C.value){const a=(C.value||"").match(/(\d{4,6})/);l=a?a[1]:""}!l&&L.value&&(l=L.value);const o=[];for(let a=s;a<t.length;a++){const c=t[a],r=c&&c.charCodeAt(0)===65279?c.slice(1):c;if(!r||r.trim()==="")break;const i=r.split("	").map(u=>(u||"").trim()),d=[l];for(let u=0;u<6;u++)d.push(i[u]||"");o.push(d)}b.value=o}const B=v(""),O=v(""),C=v(""),L=v(""),b=v([]),E=v({}),he=te(()=>{if(!E.value||!E.value.TIME)return"";const e=E.value.TIME.trim();if(!e)return"";try{const t=e.split(".");if(t.length===3){const s=t[0].padStart(2,"0"),l=t[1].padStart(2,"0"),o=t[2];return`${s}/${l}/${o}`}}catch(t){console.warn("Error formateando fecha TIME:",t)}return""}),Be=te(()=>{try{return(b.value||[]).map((e,t)=>{const s=e[1]&&e[1].trim()!==""?e[1].trim():"";let l=null;if(s){const o=s.match(/^(\d+)\//);o&&o[1]&&(l=parseInt(o[1],10))}return(!l||isNaN(l))&&(l=t+1),{TESTNR:e[0]||L.value,HUSO_ENSAYOS:s,HUSO_NUMBER:l,TIEMPO_ROTURA:e[2]&&e[2].trim()!==""?e[2]:"",FUERZA_B:e[3]&&e[3].trim()!==""?e[3]:"",ELONGACION:e[4]&&e[4].trim()!==""?e[4]:"",TENACIDAD:e[5]&&e[5].trim()!==""?e[5]:"",TRABAJO:e[6]&&e[6].trim()!==""?e[6]:""}})}catch(e){return console.warn("preparedTblPreview compute error",e),[]}}),Le=[{field:"CATALOG",row:3,col:1},{field:"TESTNR",row:8,col:5},{field:"TIME",row:9,col:8},{field:"SORTIMENT",row:10,col:5},{field:"ARTICLE",row:11,col:5},{field:"MASCHNR",row:12,col:5},{field:"MATCLASS",row:13,col:8},{field:"NOMCOUNT",row:14,col:5},{field:"NOMTWIST",row:15,col:5},{field:"USCODE",row:17,col:8},{field:"LABORANT",row:18,col:5},{field:"COMMENT",row:19,col:5},{field:"LOTE",row:20,col:5},{field:"TUNAME",row:24,col:5},{field:"GROUPS",row:25,col:5},{field:"WITHIN",row:26,col:5},{field:"TOTAL",row:27,col:5},{field:"UNSPOOLGROUPS",row:29,col:5},{field:"LENGTH",row:30,col:5},{field:"EXTSPEED",row:31,col:5},{field:"PRETENSION",row:32,col:5},{field:"CLAMPPRESSURE",row:33,col:5},{field:"CYCLEFORCELL",row:34,col:5},{field:"CYCLEFORCEUL",row:35,col:5},{field:"NMBOFFORCECYCLES",row:36,col:5},{field:"CYCLELONGLL",row:37,col:5},{field:"CYCLELONGUL",row:38,col:5},{field:"NMBOFELONGCYCLES",row:39,col:5},{field:"FORCEF1REL",row:40,col:5},{field:"ELONGATIONE1REL",row:41,col:5},{field:"EVALTIMEREL",row:42,col:5},{field:"PRELOADCYCLESREL",row:43,col:5},{field:"FORCEF1RET",row:44,col:5},{field:"ELONGATIONE1RET",row:45,col:5},{field:"EVALTIMERET",row:46,col:5},{field:"PRELOADCYCLESRET",row:47,col:5}];function ve(e){const t={};if(!e)return t;for(const s of Le){const l=H(e,s.row,s.col);t[s.field]=l!=null?String(l).trim():""}return t}function xe(){return new Promise((e,t)=>{const s=window.indexedDB.open("carga-uster");s.onupgradeneeded=()=>{const l=s.result;l.objectStoreNames.contains("handles")||l.createObjectStore("handles")},s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)})}async function Ie(e,t="dir-tenso"){const s=await xe();return new Promise((l,o)=>{const r=s.transaction("handles","readwrite").objectStore("handles").put(e,t);r.onsuccess=()=>l(!0),r.onerror=()=>o(r.error)})}async function z(e="dir-tenso"){const t=await xe();return new Promise((s,l)=>{const c=t.transaction("handles","readonly").objectStore("handles").get(e);c.onsuccess=()=>s(c.result),c.onerror=()=>l(c.error)})}async function q(e,t="read"){if(!e)return!1;try{const s={mode:t};if(await e.queryPermission(s)==="granted"||await e.requestPermission(s)==="granted")return!0}catch(s){console.warn("verifyPermission error",s)}return!1}function H(e,t,s){if(e==null)return null;const l=e.split(/\r?\n/);if(l.length<t)return null;let o=l[t-1];o&&o.charCodeAt(0)===65279&&(o=o.slice(1));const a=o.split("	");return s-1>=a.length?null:a[s-1]}async function Z(e){const t={};try{W.value=!0;for await(const[o,a]of e.entries()){if(!a||a.kind!=="file")continue;const c=String(o||"").toLowerCase();if(!(c.endsWith(".par")||c.endsWith(".tbl")))continue;const r=String(o||"");let i="";if(r.length>=12&&(i=r.slice(6,12)),(!i||!/\d{4,6}/.test(i))&&(i=(r.match(/(\d{5})/)||[])[1]||""),!!i){if(t[i]||(t[i]={testnr:i,hasPar:!1,hasTbl:!1,parHandle:null,tblHandle:null,nomcount:"",maschnr:""}),c.endsWith(".par")){t[i].hasPar=!0,t[i].parHandle=a;try{const u=await(await a.getFile()).text();t[i].nomcount=H(u,14,5)||"",t[i].maschnr=H(u,12,5)||""}catch(d){console.warn("reading .PAR during scan",o,d)}}c.endsWith(".tbl")&&(t[i].hasTbl=!0,t[i].tblHandle=a)}}}catch(o){console.warn("scanTensoDirectory error",o)}finally{W.value=!1}const s=Object.values(t).length;try{const o=typeof window<"u"&&window.location.hostname==="localhost"?"http://localhost:3001":"",a="/api/tensorapid/status",c=Object.values(t).map(r=>r.testnr);if(c.length>0){const r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({testnrs:c}),credentials:"include"});if(r.ok){const i=await r.json(),d=new Set(i.existing||[]),u=i.details||{};Object.values(t).forEach(f=>{var h;f.saved=d.has(f.testnr),f.isEditing=!1,f.usterTestnr=Y(((h=u[f.testnr])==null?void 0:h.usterTestnr)||"")})}}}catch(o){console.warn("Error checking tensorapid status (pre-assign):",o)}p.value=Object.values(t).sort((o,a)=>o.testnr.localeCompare(a.testnr));const l=Object.values(t).reduce((o,a)=>o+(a.saved?1:0),0);if(k.value=j(s,l,w.value),p.value.length>0)try{const o=typeof window<"u"&&window.location.hostname==="localhost"?"http://localhost:3001":"",a="/api/tensorapid/status",c=p.value.map(i=>i.testnr),r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({testnrs:c}),credentials:"include"});if(r.ok){const i=await r.json(),d=new Set(i.existing||[]),u=i.details||{};p.value.forEach(g=>{var V;g.saved=d.has(g.testnr),g.isEditing=!1,g.usterTestnr=Y(((V=u[g.testnr])==null?void 0:V.usterTestnr)||"")});const f=p.value.length,h=p.value.reduce((g,V)=>g+(V.saved?1:0),0);k.value=j(f,h,w.value)}}catch(o){console.warn("Error checking tensorapid status:",o)}try{localStorage.setItem("tenso.scanSnapshot",JSON.stringify(p.value))}catch(o){console.warn("persist snapshot failed",o)}}async function Q(){try{if(typeof window<"u"&&typeof window.showDirectoryPicker=="function"){const e=await window.showDirectoryPicker();if(!e)return;await Ie(e,"dir-tenso"),J.value=!0,P.value=e.name||"",await Z(e);return}$&&$.value&&$.value.click()}catch(e){console.warn("selectTensoFolder error",e)}}async function Pe(){try{const e=await z("dir-tenso");if(!e||!await q(e,"read"))return Q();J.value=!0,P.value=e.name||"",await Z(e)}catch(e){console.warn("refreshTensoFolder error",e)}}async function Fe(e){try{const t=e&&e.target&&e.target.files?Array.from(e.target.files):[],s={};for(const a of t){const c=a.name||"",r=c.toLowerCase();if(!(r.endsWith(".par")||r.endsWith(".tbl")))continue;let i="";if(c.length>=12&&(i=c.slice(6,12)),(!i||!/\d{4,6}/.test(i))&&(i=(c.match(/(\d{5})/)||[])[1]||""),!!i){if(s[i]||(s[i]={testnr:i,hasPar:!1,hasTbl:!1,nomcount:"",maschnr:""}),r.endsWith(".par")){s[i].hasPar=!0;try{const d=await a.text();s[i].nomcount=H(d,14,5)||"",s[i].maschnr=H(d,12,5)||""}catch(d){console.warn("reading .PAR fallback",d)}}r.endsWith(".tbl")&&(s[i].hasTbl=!0)}}try{const a=typeof window<"u"&&window.location.hostname==="localhost"?"http://localhost:3001":"",c="/api/tensorapid/status",r=Object.values(s).map(i=>i.testnr);if(r.length>0){const i=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({testnrs:r}),credentials:"include"});if(i.ok){const d=await i.json(),u=new Set(d.existing||[]),f=d.details||{};Object.values(s).forEach(h=>{var g;h.saved=u.has(h.testnr),h.isEditing=!1,h.usterTestnr=Y(((g=f[h.testnr])==null?void 0:g.usterTestnr)||"")})}}}catch(a){console.warn("Error checking tensorapid status (input pre-assign):",a)}p.value=Object.values(s).sort((a,c)=>a.testnr.localeCompare(c.testnr));const l=p.value.length,o=p.value.reduce((a,c)=>a+(c.saved?1:0),0);if(k.value=j(l,o,w.value),p.value.length>0)try{const a=typeof window<"u"&&window.location.hostname==="localhost"?"http://localhost:3001":"",c="/api/tensorapid/status",r=p.value.map(d=>d.testnr),i=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({testnrs:r}),credentials:"include"});if(i.ok){const d=await i.json(),u=new Set(d.existing||[]);p.value.forEach(f=>{f.saved=u.has(f.testnr),f.isEditing=!1,f.usterTestnr=""})}}catch(a){console.warn("Error checking tensorapid status:",a)}try{localStorage.setItem("tenso.scanSnapshot",JSON.stringify(p.value))}catch(a){console.warn("persist snapshot failed",a)}}catch(t){console.warn("onTensoFolderInputChangeLocal error",t)}}return je(()=>{typeof window<"u"&&typeof window.document<"u"&&(window.document.title="TensoRapid");try{const e=localStorage.getItem("tenso.scanSnapshot");if(e){const t=JSON.parse(e);Array.isArray(t)&&(p.value=t,k.value=j(t.length,null,w.value))}}catch{}try{B.value="",O.value="",b.value=[],C.value="",L.value=""}catch{}(async()=>{try{const e=await z("dir-tenso");if(!e)return;if(!await q(e,"read")){console.warn("No permission to access persisted dir-tenso");return}J.value=!0,P.value=e.name||"",await Z(e)}catch(e){console.warn("auto-load dir-tenso failed",e)}})()}),(e,t)=>(m(),y(ee,null,[t[22]||(t[22]=n("div",{class:"md:hidden p-4"},[n("div",{class:"bg-slate-50 border border-slate-200 rounded-xl p-4 text-slate-700 text-sm"}," Esta página de carga (TensoRapid) está disponible solo en escritorio (pantallas medianas o mayores). ")],-1)),n("div",Je,[n("main",We,[n("div",Ke,[t[7]||(t[7]=n("div",{class:"text-2xl font-semibold text-slate-800 mr-4"},"Datos TensoRapid",-1)),t[8]||(t[8]=n("label",{class:"text-sm font-semibold text-slate-700 mr-2 shrink-0"},"Carpeta TensoRapid:",-1)),n("div",Ye,[n("div",{class:"px-3 py-2 border border-slate-300 rounded-lg bg-slate-50 text-sm text-slate-800 truncate",title:P.value},x(P.value||"Ninguna carpeta seleccionada"),9,ze)]),n("div",qe,[n("button",{onClick:Q,class:"inline-flex items-center gap-2 px-3 py-1 border border-slate-200 bg-white text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors duration-150 shadow-sm hover:shadow-md"},[...t[5]||(t[5]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 7a2 2 0 012-2h3l2 3h6a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"})],-1),I(" Seleccionar ",-1)])]),n("button",{onClick:Pe,class:"inline-flex items-center gap-2 px-3 py-1 border border-slate-200 bg-white text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors duration-150 shadow-sm hover:shadow-md"},[...t[6]||(t[6]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),I(" Actualizar ",-1)])]),n("input",{ref_key:"tensoFolderInputLocal",ref:$,type:"file",webkitdirectory:"",directory:"",multiple:"",class:"hidden",onChange:Fe},null,544)])]),n("div",Ze,[n("div",Qe,[n("div",Xe,[n("label",et,[D(n("input",{type:"radio",name:"tenso-filter","onUpdate:modelValue":t[0]||(t[0]=s=>w.value=s),value:"all",class:"mr-2 text-indigo-600 focus:ring-indigo-500"},null,512),[[X,w.value]]),t[9]||(t[9]=n("span",{class:"text-slate-700 font-medium"},"Todos",-1))]),n("label",tt,[D(n("input",{type:"radio",name:"tenso-filter","onUpdate:modelValue":t[1]||(t[1]=s=>w.value=s),value:"not",class:"mr-2 text-indigo-600 focus:ring-indigo-500"},null,512),[[X,w.value]]),t[10]||(t[10]=n("span",{class:"text-slate-700 font-medium"},"No guardados",-1))]),n("label",st,[D(n("input",{type:"radio",name:"tenso-filter","onUpdate:modelValue":t[2]||(t[2]=s=>w.value=s),value:"saved",class:"mr-2 text-indigo-600 focus:ring-indigo-500"},null,512),[[X,w.value]]),t[11]||(t[11]=n("span",{class:"text-slate-700 font-medium"},"Guardados",-1))])]),b.value.length?(m(),y("div",nt,[n("h5",ot,[I(" Datos .TBL — TESTNR: "+x(L.value)+" ",1),he.value?(m(),y("span",rt,"• "+x(he.value),1)):_("",!0)])])):_("",!0)]),n("div",at,[n("div",lt,[n("div",it,[n("table",ct,[t[17]||(t[17]=n("colgroup",null,[n("col",{class:"col-ensayo"}),n("col",{class:"col-par"}),n("col",{class:"col-tbl"}),n("col",{class:"col-imp"}),n("col",{class:"col-ne"}),n("col",{class:"col-maq"}),n("col",{style:{width:"72px"}}),n("col",{class:"col-accion"})],-1)),t[18]||(t[18]=n("thead",{class:"sticky top-0 bg-gradient-to-r from-slate-50 to-slate-100 z-10"},[n("tr",null,[n("th",{class:"px-2 py-1 border border-slate-200 text-xs text-center font-semibold text-slate-700"}," Ensayo"),n("th",{class:"px-2 py-1 border border-slate-200 text-xs text-center font-semibold text-slate-700"}," .PAR"),n("th",{class:"px-2 py-1 border border-slate-200 text-xs text-center font-semibold text-slate-700"}," .TBL"),n("th",{class:"px-2 py-1 border border-slate-200 text-xs text-center font-semibold text-slate-700"}," Estado"),n("th",{class:"px-2 py-1 border border-slate-200 text-xs text-center font-semibold text-slate-700"}," Ne"),n("th",{class:"px-2 py-1 border border-slate-200 text-xs text-center font-semibold text-slate-700"}," Maq."),n("th",{class:"px-2 py-1 border border-slate-200 text-xs text-center font-semibold text-slate-700"}," USTER"),n("th",{class:"px-2 py-1 border border-slate-200 text-xs text-center font-semibold text-slate-700"}," Acción")])],-1)),n("tbody",null,[(m(!0),y(ee,null,ge(me.value,(s,l)=>(m(),y("tr",{key:l,class:be(["hover:bg-blue-50/30 cursor-pointer transition-colors duration-150",{"bg-blue-50":S.value===s.testnr}]),onClick:o=>Ee(s.testnr)},[n("td",ut,x(s.testnr||""),1),n("td",ft,[n("input",{type:"checkbox",disabled:"",checked:s.hasPar},null,8,pt)]),n("td",ht,[n("input",{type:"checkbox",disabled:"",checked:s.hasTbl},null,8,vt)]),n("td",xt,[s.saved===!0?(m(),y("span",wt,[...t[12]||(t[12]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 text-green-600 mx-auto",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M5 13l4 4L19 7"})],-1)])])):_("",!0)]),n("td",gt,x(s.nomcount||""),1),n("td",bt,x(s.maschnr||""),1),n("td",{class:"px-2 py-[0.3rem] border border-slate-200 text-center text-xs",onClick:t[3]||(t[3]=T(()=>{},["stop"]))},[s.testnr?D((m(),y("input",{key:0,type:"text","onUpdate:modelValue":o=>s.usterTestnr=o,placeholder:s.saved?"05410":"",maxlength:"5",inputmode:"numeric",readonly:s.saved&&!s.isEditing,ref_for:!0,ref:o=>_e(o,s.testnr),onFocus:o=>Re(s),onInput:o=>Ae(s,o),onKeydown:[R(o=>fe(s),["enter"]),R(T(o=>fe(s),["prevent"]),["right"])],class:be(["w-full px-2 py-1 text-xs text-center border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-yellow-400 font-mono transition-colors",s.saved&&!s.isEditing?"bg-slate-100 text-slate-900 cursor-default":"text-slate-900",S.value===s.testnr?"bg-yellow-50 ring-2 ring-yellow-400":"hover:bg-slate-50 focus:bg-yellow-50"])},null,42,mt)),[[De,s.usterTestnr]]):_("",!0)]),n("td",{class:"px-2 py-[0.3rem] border border-slate-200 text-center text-xs",onClick:t[4]||(t[4]=T(()=>{},["stop"]))},[Me(Ge,{name:"fade",mode:"out-in"},{default:$e(()=>[s.testnr&&s.saved&&!s.isEditing?(m(),y("div",yt,[n("button",{onClick:T(o=>ke(s),["stop"]),ref_for:!0,ref:o=>Oe(o,s.testnr),onKeydown:[R(T(o=>ce(s),["prevent"]),["left"]),R(T(o=>de(s),["prevent"]),["right"])],class:"inline-flex items-center justify-center w-28 gap-2 px-3 py-1 border border-slate-200 bg-white text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors duration-150 shadow-sm hover:shadow-md"},[...t[13]||(t[13]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15.232 5.232l3.536 3.536M9 11l6-6 3 3-6 6H9v-3z"})],-1),I(" Editar ",-1)])],40,Tt),s.isEditing?_("",!0):(m(),y("button",{key:0,onClick:T(o=>le(s),["stop"]),disabled:U.value,ref_for:!0,ref:o=>ie(o,s.testnr),onKeydown:R(T(o=>ue(s),["prevent"]),["left"]),class:"inline-flex items-center justify-center w-28 gap-2 px-3 py-1 border border-slate-200 bg-white text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors duration-150 shadow-sm hover:shadow-md disabled:opacity-50"},[t[14]||(t[14]=n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 text-red-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M10 3h4a1 1 0 011 1v2H9V4a1 1 0 011-1z"})],-1)),I(" "+x(U.value?"Eliminando...":"Eliminar"),1)],40,Et))])):s.testnr&&s.usterTestnr?(m(),y("div",St,[n("button",{onClick:o=>Se(s),disabled:A.value,ref_for:!0,ref:o=>Ne(o,s.testnr),onKeydown:[R(T(o=>ce(s),["prevent"]),["left"]),R(T(o=>de(s),["prevent"]),["right"])],class:"inline-flex items-center justify-center w-28 gap-2 px-3 py-1 border border-slate-200 bg-white text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors duration-150 shadow-sm hover:shadow-md disabled:opacity-50"},[t[15]||(t[15]=n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 text-indigo-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})],-1)),n("span",null,x(A.value?"Guardando...":"Guardar"),1)],40,kt),s.isEditing?(m(),y("button",{key:0,onClick:o=>Ce(s),disabled:A.value,class:"inline-flex items-center justify-center w-28 gap-2 px-3 py-1 border border-slate-200 bg-white text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors duration-150 shadow-sm hover:shadow-md disabled:opacity-50"},[...t[16]||(t[16]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1),I(" Cancelar ",-1)])],8,Ct)):_("",!0),s.isEditing?_("",!0):(m(),y("button",{key:1,onClick:T(o=>le(s),["stop"]),disabled:U.value,ref_for:!0,ref:o=>ie(o,s.testnr),onKeydown:R(T(o=>K(s),["prevent"]),["left"]),class:"inline-flex items-center justify-center w-28 px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 text-xs font-medium disabled:opacity-50 transition-colors duration-200 shadow-sm hover:shadow-md"},x(U.value?"Eliminando...":"Eliminar"),41,_t))])):_("",!0)]),_:2},1024)])],10,dt))),128))])])]),n("div",Nt,[n("div",Ot,x(k.value),1),W.value?(m(),y("div",Rt,[...t[19]||(t[19]=[n("svg",{class:"w-4 h-4 animate-spin text-slate-600",viewBox:"0 0 24 24",fill:"none"},[n("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),n("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})],-1),n("span",null,"Escaneando...",-1)])])):_("",!0)])]),D(n("div",At,[n("div",Ut,[n("table",Bt,[t[20]||(t[20]=n("colgroup",null,[n("col",{style:{width:"24px"}}),n("col",{class:"tbl-col-test"}),n("col",{style:{width:"48px"}}),n("col",{style:{width:"48px"}}),n("col",{class:"tbl-col-tiempo"}),n("col",{style:{width:"44px"}}),n("col",{style:{width:"32px"}}),n("col",{style:{width:"40px"}}),n("col",{style:{width:"40px"}})],-1)),t[21]||(t[21]=n("thead",{class:"sticky top-0 bg-gradient-to-r from-slate-50 to-slate-100"},[n("tr",null,[n("th",{class:"p-2 border border-slate-200 text-xs font-semibold text-slate-700"},"# "),n("th",{class:"p-2 border border-slate-200 text-xs font-semibold text-slate-700"}," Test "),n("th",{class:"p-2 border border-slate-200 text-xs font-semibold text-slate-700"},"No. "),n("th",{class:"p-2 border border-slate-200 text-xs font-semibold text-slate-700 bg-blue-50"}," Huso"),n("th",{class:"p-2 border border-slate-200 text-xs font-semibold text-slate-700"}," Tiempo Rotura"),n("th",{class:"p-2 border border-slate-200 text-xs font-semibold text-slate-700"}," Fuerza B "),n("th",{class:"p-2 border border-slate-200 text-xs font-semibold text-slate-700"}," Elong. "),n("th",{class:"p-2 border border-slate-200 text-xs font-semibold text-slate-700"}," Tenac. "),n("th",{class:"p-2 border border-slate-200 text-xs font-semibold text-slate-700"}," Trabajo ")])],-1)),n("tbody",null,[(m(!0),y(ee,null,ge(Be.value,(s,l)=>(m(),y("tr",{key:l,class:"hover:bg-blue-50/30 transition-colors duration-150"},[n("td",Lt,x(l+1),1),n("td",It,x(s.TESTNR||""),1),n("td",Pt,x(s.HUSO_ENSAYOS||""),1),n("td",Ft,x(s.HUSO_NUMBER),1),n("td",jt,x(s.TIEMPO_ROTURA||""),1),n("td",Ht,x(s.FUERZA_B||""),1),n("td",Dt,x(s.ELONGACION||""),1),n("td",Mt,x(s.TENACIDAD||""),1),n("td",$t,x(s.TRABAJO||""),1)]))),128))])])])],512),[[He,b.value.length]])])])])])],64))}},Yt=Ve(Gt,[["__scopeId","data-v-b8878125"]]);export{Yt as default};
